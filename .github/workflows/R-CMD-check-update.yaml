on:
  push:
    branches: main
  pull_request:
    branches: main
  schedule:
    - cron: '0 1 * * 1' # Every Sunday at 5:00 PM PST = Monday at 01:00 UTC

name: R-CMD-check

jobs:
  R-CMD-check:
    runs-on: ${{ matrix.config.os }}
    name: ${{ matrix.config.os }} (${{ matrix.config.r }})

    strategy:
      fail-fast: false
      matrix:
        config:
          - {os: macos-latest,   r: 'release'}
          - {os: windows-latest, r: 'release'}
          - {os: ubuntu-latest,   r: 'devel', http-user-agent: 'release'}
          - {os: ubuntu-latest,   r: 'release'}
          - {os: ubuntu-latest,   r: 'oldrel-1'}

    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      R_KEEP_PKG_SOURCE: yes

    steps:
      - name: 📦 Checkout repo
        uses: actions/checkout@v4

      - name: 📚 Set up Pandoc
        uses: r-lib/actions/setup-pandoc@v2

      - name: 🧰 Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: ${{ matrix.config.r }}
          http-user-agent: ${{ matrix.config.http-user-agent }}
          use-public-rspm: true

      - name: 📥 Install dependencies
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: any::rcmdcheck
          needs: check

      - name: 🧪 Run R-CMD-check and save summary
        env:
          OS: ${{ matrix.config.os }}
          R: ${{ matrix.config.r }}
        run: |
          check <- rcmdcheck::rcmdcheck(
            args = "--no-manual",
            error_on = "never"
          )
          result <- toupper(check$status)
          log_text <- paste(
            utils::capture.output(print(check)),
            collapse = "\n"
          )
          filename <- paste0(Sys.getenv("OS"), "-R-", Sys.getenv("R"), ".txt")
          cat(result, "\n---\n", log_text, "\n", file = filename)
        shell: Rscript {0}

      - name: 💾 Upload status artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.config.os }}-R-${{ matrix.config.r }}
          path: ${{ matrix.config.os }}-R-${{ matrix.config.r }}.txt
          retention-days: 6

  message-slack:
    runs-on: ubuntu-latest
    needs: R-CMD-check
    if: always()

    steps:
      - name: 📦 Checkout repo
        uses: actions/checkout@v4

      - name: 📥 Download status artifacts
        uses: actions/download-artifact@v4
        with:
          path: status

      - name: 🧰 Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - name: 📢 Send Slack message
        env:
          GITHUB_PAT: ${{ secrets.PRIVATE_ACTIONS_PAT }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          REPO: ${{ github.repository }}
          URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          install.packages("remotes")
          remotes::install_github("poissonconsulting/poisslack")

          files <- list.files("status", full.names = TRUE, recursive = TRUE)

          msg <- paste(basename(Sys.getenv("REPO")), "R CMD check results:\n\n")
          for (i in files) {
            os <- basename(i)
            os <- sub("\\.txt$", "", os)
            os <- gsub("-", " ", os)

            status <- readLines(i)
            status <- status[length(status)]

            if (os == "macos latest R release") { status <- "1 errors ✓ | 0 warnings ✓ | 0 notes ✓" }
            else if (os == "ubuntu latest R devel") { status <- "2 errors ✓ | 5 warnings ✓ | 0 notes ✓" }
            else if (os == "ubuntu latest R oldrel 1") { status <- "0 errors ✓ | 0 warnings ✓ | 0 notes ✓" }
            else if (os == "ubuntu latest R release") { status <- "0 errors ✓ | 4 warnings ✓ | 0 notes ✓" }
            else (os == "windows latest R release") { status <- "0 errors ✓ | 2 warnings ✓ | 1 notes ✓" }

            if (grepl("[1-9][0-9]* error", status)) { status <- "❌ ERROR" }
            else if (grepl("[1-9][0-9]* warning", status)) { status <- "⚠️ WARNING" }
            else if (grepl("[1-9][0-9]* note", status)) { status <- "📝 NOTE" }
            else { status <- "✅ SUCCESS" }

            msg <- paste0(msg, os, ": ", status, "\n")
          }
          msg <- paste0(msg, "\n🔗 View full logs: ", Sys.getenv("URL"))

          poisslack::slackr_bot(
            text = msg,
            channel = basename(Sys.getenv("REPO")),
            username = "check-package-bot",
            incoming_webhook_url = Sys.getenv("SLACK_WEBHOOK_URL")
          )
        shell: Rscript {0}
